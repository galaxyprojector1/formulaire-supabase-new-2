<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votre Projet Solaire - Formulaire</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- Barre de progression -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span id="currentStep">1</span> / <span id="totalSteps">8</span>
            </div>
        </div>

        <!-- Formulaire multi-√©tapes -->
        <form id="solarForm" class="form-container">
            
            <!-- √âtape 1: Statut occupant -->
            <div class="step active" data-step="1">
                <div class="step-content">
                    <h2 class="step-title">√ätes-vous propri√©taire ou locataire ?</h2>
                    <div class="button-group">
                        <button type="button" class="choice-btn" data-value="propri√©taire">
                            <i class="fas fa-home"></i>
                            <span>Propri√©taire</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="locataire">
                            <i class="fas fa-key"></i>
                            <span>Locataire</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- √âtape 2: Type de logement -->
            <div class="step" data-step="2">
                <div class="step-content">
                    <h2 class="step-title">Maison ou appartement ?</h2>
                    <div class="button-group">
                        <button type="button" class="choice-btn" data-value="maison">
                            <i class="fas fa-house"></i>
                            <span>Maison</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="appartement">
                            <i class="fas fa-building"></i>
                            <span>Appartement</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- √âtape 3: Mode de chauffage -->
            <div class="step" data-step="3">
                <div class="step-content">
                    <h2 class="step-title">Quel est votre mode de chauffage actuel ?</h2>
                    <div class="button-grid">
                        <button type="button" class="choice-btn" data-value="gaz">
                            <i class="fas fa-fire"></i>
                            <span>Gaz</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="√©lectrique">
                            <i class="fas fa-bolt"></i>
                            <span>√âlectrique</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="bois">
                            <i class="fas fa-tree"></i>
                            <span>Bois</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="pompe_chaleur">
                            <i class="fas fa-snowflake"></i>
                            <span>Pompe √† chaleur</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="fioul">
                            <i class="fas fa-oil-can"></i>
                            <span>Fioul</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="autre">
                            <i class="fas fa-question"></i>
                            <span>Autre</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- √âtape 4: Surface de toiture -->
            <div class="step" data-step="4">
                <div class="step-content">
                    <h2 class="step-title">Quelle est approximativement la surface de votre toiture ?</h2>
                    <div class="button-group">
                        <button type="button" class="choice-btn" data-value="moins_30">
                            <i class="fas fa-home"></i>
                            <span>Moins de 30m¬≤</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="30_60">
                            <i class="fas fa-house"></i>
                            <span>Entre 30 et 60m¬≤</span>
                        </button>
                        <button type="button" class="choice-btn" data-value="plus_60">
                            <i class="fas fa-warehouse"></i>
                            <span>Plus de 60m¬≤</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- √âtape 5: Code postal -->
            <div class="step" data-step="5">
                <div class="step-content">
                    <h2 class="step-title">Entrez votre code postal pour d√©couvrir les aides de l'√âtat disponibles dans votre r√©gion</h2>
                    <div class="input-group">
                        <input type="text" 
                               id="codePostal" 
                               name="code_postal" 
                               placeholder="75001" 
                               maxlength="5"
                               pattern="[0-9]{5}"
                               class="text-input">
                        <div class="input-error" id="codePostalError"></div>
                    </div>
                    <button type="button" class="next-btn" id="codePostalNext" disabled>
                        Continuer
                    </button>
                </div>
                
                <!-- Animation de chargement -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-content">
                        <div class="spinner"></div>
                        <p>üîÑ Analyse des aides disponibles dans votre secteur...</p>
                    </div>
                </div>
            </div>

            <!-- √âtape 6: Nom complet -->
            <div class="step" data-step="6">
                <div class="step-content">
                    <h2 class="step-title">Quel est votre nom complet ?</h2>
                    <div class="input-group">
                        <input type="text" 
                               id="nomComplet" 
                               name="nom" 
                               placeholder="Jean Dupont" 
                               class="text-input">
                        <div class="input-error" id="nomError"></div>
                    </div>
                    <button type="button" class="next-btn" id="nomNext" disabled>
                        Continuer
                    </button>
                </div>
            </div>

            <!-- √âtape 7: Email -->
            <div class="step" data-step="7">
                <div class="step-content">
                    <h2 class="step-title">Quelle est votre adresse email ?</h2>
                    <div class="input-group">
                        <input type="email" 
                               id="email" 
                               name="email" 
                               placeholder="jean.dupont@email.com" 
                               class="text-input">
                        <div class="input-error" id="emailError"></div>
                    </div>
                    <button type="button" class="next-btn" id="emailNext" disabled>
                        Continuer
                    </button>
                </div>
            </div>

            <!-- √âtape 8: T√©l√©phone -->
            <div class="step" data-step="8">
                <div class="step-content">
                    <h2 class="step-title">Votre num√©ro de t√©l√©phone (10 chiffres)</h2>
                    <div class="input-group">
                        <input type="tel" 
                               id="telephone" 
                               name="tel" 
                               placeholder="0123456789" 
                               maxlength="10"
                               pattern="[0-9]{10}"
                               class="text-input">
                        <div class="input-error" id="telError"></div>
                    </div>
                    <button type="button" class="next-btn" id="telNext" disabled>
                        Finaliser
                    </button>
                </div>
            </div>

            <!-- Page finale: Remerciement -->
            <div class="step" data-step="9">
                <div class="step-content final-step">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 class="step-title">Merci !</h2>
                    <p class="success-message">
                        Nous allons vous contacter rapidement pour vous accompagner dans votre projet solaire.
                    </p>
                    <div class="final-info">
                        <p><i class="fas fa-phone"></i> Un conseiller vous appellera dans les 24h</p>
                        <p><i class="fas fa-calculator"></i> √âtude personnalis√©e gratuite</p>
                        <p><i class="fas fa-euro-sign"></i> Calcul des aides disponibles</p>
                    </div>
                </div>
            </div>

        </form>

        <!-- Bouton retour -->
        <button type="button" class="back-btn" id="backBtn" style="display: none;">
            <i class="fas fa-arrow-left"></i>
            Retour
        </button>
    </div>

    <script>
        // Configuration Supabase int√©gr√©e
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://mmdbevzsaqbkkdgcjaql.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZGJldnpzYXFia2tkZ2NqYXFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzODc3MzEsImV4cCI6MjA2OTk2MzczMX0.YGUzhpcKixZWsRAswFQtCCnRdSOSlDOXb7UENNnem9M'
        );

        // Fonctions Supabase
        const insertLead = async (state) => {
            return await supabaseClient.from('leads').insert([{
                email: state.email || '',
                code_postal: state.code_postal || '',
                statut_occupant: state.statut_occupant || '',
                type_logement: state.type_logement || '',
                nom: state.nom || '',
                tel: state.tel || '',
                activit√©: 'solaire',
                formulaire_id: 'form_solaire_01',
                donn√©es_brutes: {
                    chauffage: state.chauffage || '',
                    surface: state.surface || '',
                    etape_actuelle: state.currentStep || 1
                },
                progression: state.currentStep || 1
            }]);
        };

        const updateLead = async (state) => {
            return await supabaseClient.from('leads')
                .update({
                    email: state.email || '',
                    code_postal: state.code_postal || '',
                    statut_occupant: state.statut_occupant || '',
                    type_logement: state.type_logement || '',
                    nom: state.nom || '',
                    tel: state.tel || '',
                    donn√©es_brutes: {
                        chauffage: state.chauffage || '',
                        surface: state.surface || '',
                        etape_actuelle: state.currentStep || 1
                    },
                    progression: state.currentStep || 1
                })
                .eq('id', state.leadId);
        };

        // √âtat global du formulaire
        const state = {
            statut_occupant: '',
            type_logement: '',
            chauffage: '',
            surface: '',
            code_postal: '',
            nom: '',
            email: '',
            tel: '',
            currentStep: 1,
            totalSteps: 8,
            leadId: null
        };

        // Fonctions de validation
        const validateEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        const validatePhone = (phone) => /^[0-9]{10}$/.test(phone);
        const validatePostalCode = (code) => /^[0-9]{5}$/.test(code);
        const validateName = (name) => /^[a-zA-Z√Ä-√ø\s\-']+$/.test(name);

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            loadSavedData();
        });

        function initializeForm() {
            updateProgressBar();
            setupEventListeners();
            updateBackButton();
        }

        function setupEventListeners() {
            setupChoiceButtons();
            setupInputFields();
            document.getElementById('backBtn').addEventListener('click', goToPreviousStep);
        }

        function setupChoiceButtons() {
            // √âtape 1: Statut occupant
            const statutButtons = document.querySelectorAll('[data-step="1"] .choice-btn');
            statutButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    selectChoice(this, 'statut_occupant');
                    setTimeout(() => goToNextStep(), 300);
                });
            });

            // √âtape 2: Type de logement
            const logementButtons = document.querySelectorAll('[data-step="2"] .choice-btn');
            logementButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    selectChoice(this, 'type_logement');
                    setTimeout(() => goToNextStep(), 300);
                });
            });

            // √âtape 3: Chauffage
            const chauffageButtons = document.querySelectorAll('[data-step="3"] .choice-btn');
            chauffageButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    selectChoice(this, 'chauffage');
                    setTimeout(() => goToNextStep(), 300);
                });
            });

            // √âtape 4: Surface
            const surfaceButtons = document.querySelectorAll('[data-step="4"] .choice-btn');
            surfaceButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    selectChoice(this, 'surface');
                    setTimeout(() => goToNextStep(), 300);
                });
            });
        }

        function setupInputFields() {
            // Code postal
            const codePostalInput = document.getElementById('codePostal');
            const codePostalNext = document.getElementById('codePostalNext');
            
            codePostalInput.addEventListener('input', validateCodePostal);
            codePostalNext.addEventListener('click', function() {
                if (validateCodePostal()) {
                    showLoadingAnimation();
                }
            });

            // Nom complet
            const nomInput = document.getElementById('nomComplet');
            const nomNext = document.getElementById('nomNext');
            
            nomInput.addEventListener('input', validateNom);
            nomNext.addEventListener('click', function() {
                if (validateNom()) {
                    goToNextStep();
                }
            });

            // Email
            const emailInput = document.getElementById('email');
            const emailNext = document.getElementById('emailNext');
            
            emailInput.addEventListener('input', validateEmailField);
            emailNext.addEventListener('click', function() {
                if (validateEmailField()) {
                    goToNextStep();
                }
            });

            // T√©l√©phone
            const telInput = document.getElementById('telephone');
            const telNext = document.getElementById('telNext');
            
            telInput.addEventListener('input', validateTelephone);
            telNext.addEventListener('click', function() {
                if (validateTelephone()) {
                    goToNextStep();
                }
            });
        }

        async function selectChoice(button, fieldName) {
            // D√©s√©lectionner les autres boutons du m√™me groupe
            const siblings = button.parentElement.querySelectorAll('.choice-btn');
            siblings.forEach(btn => btn.classList.remove('selected'));
            
            // S√©lectionner le bouton cliqu√©
            button.classList.add('selected');
            
            // Sauvegarder la valeur
            state[fieldName] = button.dataset.value;
            saveToLocalStorage();
            
            // ‚úÖ MODIFICATION : Plus de sauvegarde Supabase ici !
            // await saveToSupabase(); ‚Üê SUPPRIM√â
        }

        function validateCodePostal() {
            const input = document.getElementById('codePostal');
            const button = document.getElementById('codePostalNext');
            const error = document.getElementById('codePostalError');
            
            const value = input.value.trim();
            
            if (value.length === 0) {
                button.disabled = true;
                error.textContent = '';
                input.classList.remove('error');
                return false;
            }
            
            if (!validatePostalCode(value)) {
                button.disabled = true;
                error.textContent = 'Le code postal doit contenir exactement 5 chiffres';
                input.classList.add('error');
                return false;
            }
            
            button.disabled = false;
            error.textContent = '';
            input.classList.remove('error');
            state.code_postal = value;
            saveToLocalStorage();
            return true;
        }

        function validateNom() {
            const input = document.getElementById('nomComplet');
            const button = document.getElementById('nomNext');
            const error = document.getElementById('nomError');
            
            const value = input.value.trim();
            
            if (value.length === 0) {
                button.disabled = true;
                error.textContent = '';
                input.classList.remove('error');
                return false;
            }
            
            if (!validateName(value)) {
                button.disabled = true;
                error.textContent = 'Nom invalide (pas de chiffres ou caract√®res sp√©ciaux)';
                input.classList.add('error');
                return false;
            }
            
            button.disabled = false;
            error.textContent = '';
            input.classList.remove('error');
            state.nom = value;
            saveToLocalStorage();
            return true;
        }

        function validateEmailField() {
            const input = document.getElementById('email');
            const button = document.getElementById('emailNext');
            const error = document.getElementById('emailError');
            
            const value = input.value.trim();
            
            if (value.length === 0) {
                button.disabled = true;
                error.textContent = '';
                input.classList.remove('error');
                return false;
            }
            
            if (!validateEmail(value)) {
                button.disabled = true;
                error.textContent = 'Format d\'email invalide';
                input.classList.add('error');
                return false;
            }
            
            button.disabled = false;
            error.textContent = '';
            input.classList.remove('error');
            state.email = value;
            saveToLocalStorage();
            
            // ‚úÖ AJOUT : Sauvegarder dans Supabase d√®s qu'on a l'email
            saveToSupabase();
            
            return true;
        }

        function validateTelephone() {
            const input = document.getElementById('telephone');
            const button = document.getElementById('telNext');
            const error = document.getElementById('telError');
            
            const value = input.value.trim();
            
            if (value.length === 0) {
                button.disabled = true;
                error.textContent = '';
                input.classList.remove('error');
                return false;
            }
            
            if (!validatePhone(value)) {
                button.disabled = true;
                error.textContent = 'Le num√©ro doit contenir exactement 10 chiffres';
                input.classList.add('error');
                return false;
            }
            
            button.disabled = false;
            error.textContent = '';
            input.classList.remove('error');
            state.tel = value;
            saveToLocalStorage();
            return true;
        }

        function showLoadingAnimation() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('show');
            
            setTimeout(() => {
                overlay.classList.remove('show');
                goToNextStep();
            }, 2000);
        }

        function goToNextStep() {
            if (state.currentStep < state.totalSteps + 1) {
                state.currentStep++;
                showStep(state.currentStep);
                updateProgressBar();
                updateBackButton();
                saveToLocalStorage();
                saveToSupabase();
            }
        }

        function goToPreviousStep() {
            if (state.currentStep > 1) {
                state.currentStep--;
                showStep(state.currentStep);
                updateProgressBar();
                updateBackButton();
                saveToLocalStorage();
            }
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            const currentStepElement = document.querySelector(`[data-step="${stepNumber}"]`);
            if (currentStepElement) {
                currentStepElement.classList.add('active');
            }
        }

        function updateProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const currentStepSpan = document.getElementById('currentStep');
            
            const progressPercentage = (state.currentStep / state.totalSteps) * 100;
            progressFill.style.width = `${Math.min(progressPercentage, 100)}%`;
            
            currentStepSpan.textContent = Math.min(state.currentStep, state.totalSteps);
        }

        function updateBackButton() {
            const backBtn = document.getElementById('backBtn');
            
            if (state.currentStep > 1 && state.currentStep <= state.totalSteps) {
                backBtn.style.display = 'flex';
            } else {
                backBtn.style.display = 'none';
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('solarFormData', JSON.stringify(state));
        }

        async function saveToSupabase() {
            try {
                // ‚úÖ MODIFICATION : Ne sauvegarder QUE si on a un email
                if (!state.email || state.email === '') {
                    console.log('‚è≥ Pas de sauvegarde Supabase sans email');
                    return; // Pas de sauvegarde sans email
                }

                if (!state.leadId) {
                    // Premi√®re sauvegarde - insertion (seulement avec email)
                    const result = await insertLead(state);
                    if (result.data && result.data[0]) {
                        state.leadId = result.data[0].id;
                        saveToLocalStorage();
                        console.log('‚úÖ Lead cr√©√©:', state.leadId);
                    }
                } else {
                    // Mise √† jour
                    await updateLead(state);
                    console.log('‚úÖ Lead mis √† jour:', state.leadId);
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Erreur sauvegarde Supabase:', error);
                // Continue quand m√™me - donn√©es sauv√©es localement
            }
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('solarFormData');
            
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                Object.assign(state, parsedData);
                
                showStep(state.currentStep);
                updateProgressBar();
                updateBackButton();
                
                restoreButtonSelections();
                restoreInputValues();
            }
        }

        function restoreButtonSelections() {
            if (state.statut_occupant) {
                const statutBtn = document.querySelector(`[data-step="1"] [data-value="${state.statut_occupant}"]`);
                if (statutBtn) statutBtn.classList.add('selected');
            }
            
            if (state.type_logement) {
                const logementBtn = document.querySelector(`[data-step="2"] [data-value="${state.type_logement}"]`);
                if (logementBtn) logementBtn.classList.add('selected');
            }
            
            if (state.chauffage) {
                const chauffageBtn = document.querySelector(`[data-step="3"] [data-value="${state.chauffage}"]`);
                if (chauffageBtn) chauffageBtn.classList.add('selected');
            }
            
            if (state.surface) {
                const surfaceBtn = document.querySelector(`[data-step="4"] [data-value="${state.surface}"]`);
                if (surfaceBtn) surfaceBtn.classList.add('selected');
            }
        }

        function restoreInputValues() {
            if (state.code_postal) {
                const codePostalInput = document.getElementById('codePostal');
                if (codePostalInput) {
                    codePostalInput.value = state.code_postal;
                    validateCodePostal();
                }
            }
            
            if (state.nom) {
                const nomInput = document.getElementById('nomComplet');
                if (nomInput) {
                    nomInput.value = state.nom;
                    validateNom();
                }
            }
            
            if (state.email) {
                const emailInput = document.getElementById('email');
                if (emailInput) {
                    emailInput.value = state.email;
                    validateEmailField();
                }
            }
            
            if (state.tel) {
                const telInput = document.getElementById('telephone');
                if (telInput) {
                    telInput.value = state.tel;
                    validateTelephone();
                }
            }
        }

        // Pr√©venir la soumission accidentelle du formulaire
        document.getElementById('solarForm').addEventListener('submit', function(e) {
            e.preventDefault();
        });

        console.log('Formulaire solaire initialis√© - Version mobile optimis√©e avec sauvegarde automatique - INSERT √† partir du mail');
    </script>
</body>
</html>